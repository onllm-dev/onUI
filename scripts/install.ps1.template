$ErrorActionPreference = 'Stop'

$Version = '__ONUI_VERSION__'
$Repo = 'onllm-dev/onUI'
$Tag = "v$Version"
$ReleaseBaseUrl = "https://github.com/$Repo/releases/download/$Tag"
$ExtensionZipName = "onui-extension-v$Version.zip"

$OnuiHome = if ($env:ONUI_HOME) { $env:ONUI_HOME } else { Join-Path $env:USERPROFILE '.onui' }
$ExtensionDir = Join-Path $OnuiHome "extension\v$Version"
$SourceDir = Join-Path $OnuiHome "src\onUI-v$Version"
$ZipPath = Join-Path $OnuiHome $ExtensionZipName

function Write-Log {
  param([string]$Message)
  Write-Host "[onui-install] $Message"
}

function Fail {
  param([string]$Message)
  throw "[onui-install][error] $Message"
}

function Require-Command {
  param([string]$Name)
  if (-not (Get-Command $Name -ErrorAction SilentlyContinue)) {
    Fail "Required command not found: $Name"
  }
}

function Check-NodeVersion {
  $major = node -p "process.versions.node.split('.')[0]"
  if ([int]$major -lt 20) {
    Fail "Node.js 20+ is required. Found: $(node -v)"
  }
}

Write-Log 'Checking prerequisites'
Require-Command 'git'
Require-Command 'node'
Require-Command 'pnpm'
Check-NodeVersion

New-Item -ItemType Directory -Path $OnuiHome -Force | Out-Null

Write-Log "Downloading extension artifact for $Tag"
Invoke-WebRequest -Uri "$ReleaseBaseUrl/$ExtensionZipName" -OutFile $ZipPath

Write-Log "Installing extension files into $ExtensionDir"
if (Test-Path $ExtensionDir) {
  Remove-Item -Path $ExtensionDir -Recurse -Force
}
New-Item -ItemType Directory -Path $ExtensionDir -Force | Out-Null
Expand-Archive -Path $ZipPath -DestinationPath $ExtensionDir -Force

Write-Log "Fetching source at $Tag"
if (Test-Path $SourceDir) {
  Remove-Item -Path $SourceDir -Recurse -Force
}
& git clone --depth 1 --branch $Tag "https://github.com/$Repo.git" $SourceDir
if ($LASTEXITCODE -ne 0) {
  Fail 'Failed to clone release source.'
}

Push-Location $SourceDir
try {
  Write-Log 'Building MCP server and running setup'
  & pnpm install --frozen-lockfile
  if ($LASTEXITCODE -ne 0) { Fail 'pnpm install failed.' }

  & pnpm --filter @onui/core run build
  if ($LASTEXITCODE -ne 0) { Fail 'Core build failed.' }

  & pnpm --filter @onui/mcp-server run build
  if ($LASTEXITCODE -ne 0) { Fail 'MCP build failed.' }

  & pnpm --filter @onui/mcp-server run setup
  if ($LASTEXITCODE -ne 0) { Fail 'MCP setup failed.' }

  & pnpm --filter @onui/mcp-server run doctor
  $doctorExit = $LASTEXITCODE
  if ($doctorExit -eq 2) {
    Fail 'MCP doctor reported critical failures. Please fix and rerun install.'
  }
  if ($doctorExit -eq 1) {
    Write-Warning 'MCP doctor reported warnings. Installation completed, but review warnings above.'
  }
} finally {
  Pop-Location
}

try {
  Start-Process 'chrome://extensions' -ErrorAction Stop | Out-Null
} catch {
  # Non-fatal if Chrome URL handler is unavailable.
}

Write-Host ''
Write-Host "onUI install completed for version $Version."
Write-Host ''
Write-Host 'Final manual step required (Chrome policy):'
Write-Host '1. Open chrome://extensions'
Write-Host '2. Enable Developer mode'
Write-Host '3. Click Load unpacked'
Write-Host "4. Select: $ExtensionDir"
Write-Host ''
Write-Host 'Note: Since April 2025, branded Chrome no longer supports command-line sideload flags for normal users.'
Write-Host ''

param(
  [switch]$Mcp
)

$ErrorActionPreference = "Stop"

$Version = "__VERSION__"
$Repo = "onllm-dev/onUI"
$BaseUrl = if ($env:ONUI_RELEASE_BASE_URL) { $env:ONUI_RELEASE_BASE_URL } else { "https://github.com/$Repo" }
$OnuiHome = if ($env:ONUI_HOME) { $env:ONUI_HOME } else { Join-Path $HOME "onUI" }
$ExtRoot = Join-Path $OnuiHome "extensions"
$ExtDir = Join-Path $ExtRoot "v$Version"
$CurrentDir = Join-Path $ExtRoot "current"
$ExtUrl = "$BaseUrl/releases/download/v$Version/onui-extension-unpacked-v$Version.zip"
$McpUrl = "$BaseUrl/releases/download/v$Version/onui-mcp-bundle-v$Version.zip"
$McpDir = Join-Path (Join-Path $OnuiHome "mcp") "v$Version"
$mcpEnv = if ($env:ONUI_INSTALL_MCP) { $env:ONUI_INSTALL_MCP.ToLowerInvariant() } else { "" }
$InstallMcp = $Mcp -or (@("1", "true", "yes", "y") -contains $mcpEnv)

function Write-Log($Message) {
  Write-Host "[onui-install] $Message"
}

function Require-Command($CommandName) {
  if (-not (Get-Command $CommandName -ErrorAction SilentlyContinue)) {
    throw "Missing required command: $CommandName"
  }
}

function Show-NodeInstallHelp {
  Write-Log "Install Node 20+ and rerun this installer."
  if (Get-Command winget -ErrorAction SilentlyContinue) {
    Write-Host "Install command: winget install OpenJS.NodeJS.LTS"
  } elseif (Get-Command choco -ErrorAction SilentlyContinue) {
    Write-Host "Install command: choco install nodejs-lts -y"
  } elseif (Get-Command scoop -ErrorAction SilentlyContinue) {
    Write-Host "Install command: scoop install nodejs-lts"
  } else {
    Write-Host "Install Node 20+ from: https://nodejs.org/en/download"
  }
  Write-Host "After installation, open a new PowerShell window and rerun this installer command."
}

function Install-Extension {
  Require-Command "Invoke-WebRequest"
  Require-Command "Expand-Archive"

  New-Item -ItemType Directory -Path $ExtRoot -Force | Out-Null
  $tmpZip = Join-Path $env:TEMP "onui-extension-$Version.zip"

  Write-Log "Downloading extension release artifact v$Version"
  Invoke-WebRequest -Uri $ExtUrl -OutFile $tmpZip

  if (Test-Path $ExtDir) {
    Remove-Item -Path $ExtDir -Recurse -Force
  }
  New-Item -ItemType Directory -Path $ExtDir -Force | Out-Null
  Expand-Archive -Path $tmpZip -DestinationPath $ExtDir -Force
  Remove-Item -Path $tmpZip -Force

  if (Test-Path $CurrentDir) {
    Remove-Item -Path $CurrentDir -Recurse -Force
  }

  try {
    New-Item -ItemType SymbolicLink -Path $CurrentDir -Target $ExtDir -Force | Out-Null
  } catch {
    New-Item -ItemType Directory -Path $CurrentDir -Force | Out-Null
    Copy-Item -Path (Join-Path $ExtDir "*") -Destination $CurrentDir -Recurse -Force
  }

  Write-Log "Extension installed."
  Write-Host "Load unpacked path: $CurrentDir"
}

function Should-InstallMcp {
  if ($InstallMcp) {
    return $true
  }

  $answer = Read-Host "Set up local MCP bridge now? [y/N]"
  return ($answer -match "^(y|yes)$")
}

function Install-Mcp {
  if (-not (Get-Command node -ErrorAction SilentlyContinue)) {
    Write-Log "Node is required for MCP setup but is not installed."
    Show-NodeInstallHelp
    return
  }
  Require-Command "Expand-Archive"

  $nodeMajor = [int](node -p "process.versions.node.split('.')[0]")
  if ($nodeMajor -lt 20) {
    Write-Log "Node 20+ required for MCP setup. Found $(node -v)."
    Show-NodeInstallHelp
    return
  }

  $tmpZip = Join-Path $env:TEMP "onui-mcp-$Version.zip"

  Write-Log "Downloading prebuilt MCP bundle v$Version"
  try {
    Invoke-WebRequest -Uri $McpUrl -OutFile $tmpZip
  } catch {
    Write-Log "Could not download MCP bundle for v$Version. Skipping MCP setup."
    return
  }

  if (Test-Path $McpDir) {
    Remove-Item -Path $McpDir -Recurse -Force
  }
  New-Item -ItemType Directory -Path $McpDir -Force | Out-Null
  Expand-Archive -Path $tmpZip -DestinationPath $McpDir -Force
  Remove-Item -Path $tmpZip -Force

  $doctorCliPath = Join-Path $McpDir "dist/bin/onui-cli.js"
  if (-not (Test-Path $doctorCliPath)) {
    Write-Log "MCP CLI not found in bundle; skipping MCP setup."
    return
  }

  & node $doctorCliPath setup
  if ($LASTEXITCODE -ne 0) {
    Write-Log "MCP setup command failed. Extension install is complete; run MCP setup manually later."
    return
  }

  $doctorJson = ""
  try {
    $doctorJson = & node $doctorCliPath doctor --json 2>$null
  } catch {
    $doctorJson = ""
  }

  $doctorStatus = "unknown"
  if ($doctorJson) {
    try {
      $doctorReport = $doctorJson | ConvertFrom-Json
      if ($doctorReport.status) {
        $doctorStatus = [string]$doctorReport.status
      }
    } catch {
      $doctorStatus = "unknown"
    }
  }

  if ($doctorStatus -eq "error") {
    Write-Log "MCP doctor reported errors. Extension install is complete; rerun MCP doctor manually later."
    return
  }

  if ($doctorStatus -eq "warning") {
    Write-Log "MCP doctor reported warnings (non-fatal)."
  }

  Write-Log "MCP setup complete."
}

function Print-FinalSteps {
  Write-Host ""
  Write-Host "Final Chrome step (still required):"
  Write-Host "1) Open chrome://extensions"
  Write-Host "2) Enable Developer mode"
  Write-Host "3) Click Load unpacked"
  Write-Host "4) Select: $CurrentDir"
  Write-Host ""
  try {
    Start-Process "chrome://extensions" | Out-Null
  } catch {
  }
}

Install-Extension

if (Should-InstallMcp) {
  try {
    Install-Mcp
  } catch {
    Write-Log "MCP setup failed. Extension install is complete; run MCP setup manually later."
    Write-Log $_.Exception.Message
  }
}

Print-FinalSteps

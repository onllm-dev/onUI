#!/usr/bin/env bash
set -euo pipefail

VERSION="__VERSION__"
REPO="onllm-dev/onUI"
BASE_URL="${ONUI_RELEASE_BASE_URL:-https://github.com/${REPO}}"
ONUI_HOME="${ONUI_HOME:-$HOME/onUI}"
EXT_ROOT="${ONUI_HOME}/extensions"
EXT_DIR="${EXT_ROOT}/v${VERSION}"
CURRENT_LINK="${EXT_ROOT}/current"
EXT_URL="${BASE_URL}/releases/download/v${VERSION}/onui-extension-unpacked-v${VERSION}.zip"
SRC_URL="https://codeload.github.com/${REPO}/tar.gz/refs/tags/v${VERSION}"
MCP_SRC_DIR="${ONUI_HOME}/mcp-src/v${VERSION}"

INSTALL_MCP=0

log() {
  printf '[onui-install] %s\n' "$1"
}

fail() {
  printf '[onui-install] ERROR: %s\n' "$1" >&2
  exit 1
}

warn() {
  printf '[onui-install] WARN: %s\n' "$1" >&2
}

require_cmd() {
  command -v "$1" >/dev/null 2>&1 || fail "Missing required command: $1"
}

open_chrome_extensions() {
  if command -v open >/dev/null 2>&1; then
    open "chrome://extensions" >/dev/null 2>&1 || true
    return
  fi
  if command -v xdg-open >/dev/null 2>&1; then
    xdg-open "chrome://extensions" >/dev/null 2>&1 || true
  fi
}

usage() {
  cat <<'EOF'
Usage:
  install.sh [--mcp] [--help]

Options:
  --mcp   Also run local MCP setup.
  --help  Show this help.
EOF
}

parse_args() {
  while [ "$#" -gt 0 ]; do
    case "$1" in
      --mcp)
        INSTALL_MCP=1
        ;;
      --help|-h)
        usage
        exit 0
        ;;
      *)
        fail "Unknown option: $1"
        ;;
    esac
    shift
  done
}

install_extension() {
  require_cmd curl
  require_cmd unzip

  mkdir -p "$EXT_ROOT"
  local tmp_zip
  tmp_zip="$(mktemp)"

  log "Downloading extension release artifact v${VERSION}"
  curl -fsSL "$EXT_URL" -o "$tmp_zip"

  log "Installing extension files to $EXT_DIR"
  rm -rf "$EXT_DIR"
  mkdir -p "$EXT_DIR"
  unzip -oq "$tmp_zip" -d "$EXT_DIR"
  rm -f "$tmp_zip"

  ln -sfn "$EXT_DIR" "$CURRENT_LINK"

  log "Extension installed."
  printf 'Load unpacked path: %s\n' "$CURRENT_LINK"
}

prompt_for_mcp() {
  if [ "$INSTALL_MCP" -eq 1 ]; then
    return
  fi

  local answer=""
  if [ -r /dev/tty ]; then
    printf 'Set up local MCP bridge now? [y/N]: ' > /dev/tty
    IFS= read -r answer < /dev/tty || true
  elif [ -t 0 ]; then
    printf 'Set up local MCP bridge now? [y/N]: '
    IFS= read -r answer || true
  else
    log "Non-interactive mode detected; skipping MCP setup by default."
    return
  fi

  case "$answer" in
    y|Y|yes|YES)
      INSTALL_MCP=1
      ;;
    *)
      INSTALL_MCP=0
      ;;
  esac
}

install_mcp() {
  [ "$INSTALL_MCP" -eq 1 ] || return 0

  require_cmd node
  require_cmd pnpm
  require_cmd tar
  require_cmd curl

  local node_major
  node_major="$(node -p "process.versions.node.split('.')[0]")"
  if [ "$node_major" -lt 20 ]; then
    fail "Node 20+ required for MCP setup. Found $(node -v)"
  fi

  local tmp_tgz
  tmp_tgz="$(mktemp)"

  log "Downloading source bundle for MCP setup"
  if ! curl -fsSL "$SRC_URL" -o "$tmp_tgz"; then
    warn "Could not download MCP source bundle for v${VERSION}. Skipping MCP setup."
    return 0
  fi

  rm -rf "$MCP_SRC_DIR"
  mkdir -p "$MCP_SRC_DIR"
  if ! tar -xzf "$tmp_tgz" --strip-components=1 -C "$MCP_SRC_DIR"; then
    warn "Could not extract MCP source bundle. Skipping MCP setup."
    rm -f "$tmp_tgz"
    return 0
  fi
  rm -f "$tmp_tgz"

  log "Running MCP setup"
  if ! (
    cd "$MCP_SRC_DIR"
    pnpm install --frozen-lockfile
    pnpm --filter @onui/core run build
    pnpm --filter @onui/mcp-server run build
    pnpm --filter @onui/mcp-server run setup
  ); then
    warn "MCP setup failed. Extension install is complete; run MCP setup manually later."
    return 0
  fi

  local doctor_report
  doctor_report="$(
    cd "$MCP_SRC_DIR"
    pnpm --filter @onui/mcp-server run doctor -- --json 2>/dev/null || true
  )"

  local doctor_status
  doctor_status="$(printf '%s\n' "$doctor_report" | node -e '
    const fs = require("node:fs");
    const text = fs.readFileSync(0, "utf8").trim();
    try {
      const report = JSON.parse(text);
      process.stdout.write(String(report.status || "unknown"));
    } catch {
      process.stdout.write("unknown");
    }
  ')"

  if [ "$doctor_status" = "error" ]; then
    warn "MCP doctor reported errors. Extension install is complete; fix MCP with: pnpm --filter @onui/mcp-server run doctor"
    return 0
  fi

  if [ "$doctor_status" = "warning" ]; then
    warn "MCP doctor reported warnings (non-fatal)."
  fi

  log "MCP setup complete."
}

print_final_steps() {
  printf '\nFinal Chrome step (still required):\n'
  printf '1) Open chrome://extensions\n'
  printf '2) Enable Developer mode\n'
  printf '3) Click Load unpacked\n'
  printf '4) Select: %s\n' "$CURRENT_LINK"
  printf '\n'
  open_chrome_extensions
}

main() {
  parse_args "$@"
  install_extension
  prompt_for_mcp
  install_mcp
  print_final_steps
}

main "$@"
